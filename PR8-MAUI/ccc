<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="PR8_MAUI.Views.EditUserPage"
             Title="Редактирование профиля">
    
    <ScrollView>
        <VerticalStackLayout Padding="20" Spacing="15">
            <Label Text="Редактирование профиля" 
                   FontSize="22" 
                   FontAttributes="Bold" 
                   HorizontalOptions="Center"/>
            
            <!-- Поле для имени -->
            <Frame BackgroundColor="#F5F5F5" Padding="15">
                <VerticalStackLayout Spacing="5">
                    <Label Text="Имя:" FontAttributes="Bold"/>
                    <Entry x:Name="UserNameEntry" 
                           Placeholder="Введите ваше имя"
                           TextChanged="OnTextChanged"/>
                </VerticalStackLayout>
            </Frame>

            <!-- Поле для email -->
            <Frame BackgroundColor="#F5F5F5" Padding="15">
                <VerticalStackLayout Spacing="5">
                    <Label Text="Email:" FontAttributes="Bold"/>
                    <Entry x:Name="UserEmailEntry" 
                           Placeholder="Введите email"
                           Keyboard="Email"
                           TextChanged="OnTextChanged"/>
                </VerticalStackLayout>
            </Frame>

            <!-- Поле для телефона -->
            <Frame BackgroundColor="#F5F5F5" Padding="15">
                <VerticalStackLayout Spacing="5">
                    <Label Text="Телефон:" FontAttributes="Bold"/>
                    <Entry x:Name="UserPhoneEntry" 
                           Placeholder="Введите телефон"
                           Keyboard="Telephone"
                           TextChanged="OnTextChanged"/>
                </VerticalStackLayout>
            </Frame>

            <!-- Поле для пароля (опционально) -->
            <Frame BackgroundColor="#F5F5F5" Padding="15">
                <VerticalStackLayout Spacing="5">
                    <Label Text="Новый пароль (необязательно):" FontAttributes="Bold"/>
                    <Entry x:Name="UserPasswordEntry" 
                           Placeholder="Введите новый пароль"
                           IsPassword="True"
                           TextChanged="OnTextChanged"/>
                </VerticalStackLayout>
            </Frame>

            <Label x:Name="ErrorLabel" 
                   TextColor="Red" 
                   HorizontalOptions="Center"
                   IsVisible="False"/>

            <!-- Кнопки -->
            <Grid ColumnDefinitions="*,*" ColumnSpacing="10" Margin="0,20">
                <Button Grid.Column="0" 
                        Text="Сохранить" 
                        Clicked="OnSaveClicked"
                        BackgroundColor="#4CAF50" 
                        TextColor="White"
                        HeightRequest="50"/>
                        
                <Button Grid.Column="1" 
                        Text="Отмена" 
                        Clicked="OnCancelClicked"
                        BackgroundColor="#9E9E9E" 
                        TextColor="White"
                        HeightRequest="50"/>
            </Grid>
        </VerticalStackLayout>
    </ScrollView>
</ContentPage>

using Microsoft.Maui.Controls;
using PR8_MAUI.Models;

namespace PR8_MAUI.Views
{
    public partial class EditUserPage : ContentPage
    {
        private bool _isDataChanged = false;

        public EditUserPage()
        {
            InitializeComponent();
            LoadUserData();
        }

        private void LoadUserData()
        {
            UserNameEntry.Text = AppData.UserName;
            UserEmailEntry.Text = AppData.UserEmail;
            UserPhoneEntry.Text = AppData.UserPhone;
            UserPasswordEntry.Text = ""; // Пароль не показываем
            _isDataChanged = false;
        }

        private void OnTextChanged(object sender, TextChangedEventArgs e)
        {
            _isDataChanged = true;
        }

        private async void OnSaveClicked(object sender, EventArgs e)
        {
            // Проверка валидности данных
            if (string.IsNullOrWhiteSpace(UserNameEntry.Text))
            {
                ShowError("Имя не может быть пустым");
                return;
            }

            if (string.IsNullOrWhiteSpace(UserEmailEntry.Text))
            {
                ShowError("Email не может быть пустым");
                return;
            }

            // Сохраняем данные
            AppData.UserName = UserNameEntry.Text.Trim();
            AppData.UserEmail = UserEmailEntry.Text.Trim();
            AppData.UserPhone = UserPhoneEntry.Text.Trim();

            // Если указан новый пароль, сохраняем его
            if (!string.IsNullOrWhiteSpace(UserPasswordEntry.Text))
            {
                AppData.UserPassword = UserPasswordEntry.Text;
            }

            await DisplayAlert("Успех", "Данные профиля сохранены", "OK");
            await Navigation.PopAsync(); // Возвращаемся на предыдущую страницу
        }

        private async void OnCancelClicked(object sender, EventArgs e)
        {
            if (_isDataChanged)
            {
                bool answer = await DisplayAlert("Подтверждение", 
                    "У вас есть несохраненные изменения. Вы уверены, что хотите выйти?", 
                    "Да", "Нет");
                
                if (!answer)
                    return;
            }
            
            await Navigation.PopAsync();
        }

        private void ShowError(string message)
        {
            ErrorLabel.Text = message;
            ErrorLabel.IsVisible = true;
        }

        protected override bool OnBackButtonPressed()
        {
            // Обработка кнопки "Назад" на Android
            if (_isDataChanged)
            {
                Device.BeginInvokeOnMainThread(async () =>
                {
                    bool answer = await DisplayAlert("Подтверждение", 
                        "У вас есть несохраненные изменения. Вы уверены, что хотите выйти?", 
                        "Да", "Нет");
                    
                    if (answer)
                        await Navigation.PopAsync();
                });
                return true; // Отменяем стандартное поведение
            }
            return base.OnBackButtonPressed();
        }
    }
}